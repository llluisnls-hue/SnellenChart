<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Snellen en filas ‚Äì 20/400 ‚Üí 20/20</title>
<style>
  :root { --fg:#111; --bg:#fff; --mut:#777; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #e5e5e5;background:var(--bg)}
  header .grp{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  header label{font-size:13px;opacity:.9}
  header input[type="number"]{width:6.5rem;padding:6px}
  header select{padding:6px}
  .btn{padding:6px 10px;border:1px solid #999;background:#f7f7f7;border-radius:6px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .small{font-size:12px;color:var(--mut)}
  main{padding:12px 10px;max-width:1200px;margin:0 auto}
  .barWrap{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:6px}
  .bar{height:12px;background:#ccc;border:1px solid #999;box-shadow:inset 0 0 0 2px #eee}
  #chart{display:grid;gap:16px;align-content:start;margin-top:8px}
  .rowWrap{display:flex;flex-direction:column;align-items:center}
  .row{display:flex;gap:1ch;justify-content:center;align-items:flex-end;line-height:1}
  .cell{display:inline-block;font-weight:700;user-select:none;-webkit-user-select:none}
  .tumble{display:inline-block;transform-origin:50% 50%}
  .label{font-size:12px;text-align:center;margin-top:4px;color:var(--mut)}
</style>
</head>
<body>

<header>
  <div class="grp">
    <label>Distancia (m):
      <input id="distanceM" type="number" min="0.5" max="10" step="0.1" value="3.0">
    </label>
  </div>

  <div class="grp">
    <label>Signos:
      <select id="alphabet" title="Sloan o E giratoria">
        <option value="sloan">Sloan (CDHKNORSVZ)</option>
        <option value="tumbleE">E giratoria (Tumbling-E)</option>
      </select>
    </label>
  </div>

  <div class="grp">
    <label>Filas:
      <select id="rowsPreset">
        <option value="8">8</option>
        <option value="10" selected>10</option>
        <option value="12">12</option>
      </select>
    </label>
  </div>

  <div class="grp">
    <label>Vista:
      <select id="viewMode">
        <option value="all" selected>Todas las filas</option>
        <option value="one">Una fila</option>
      </select>
    </label>
    <button id="prevRow" class="btn">‚üµ Anterior</button>
    <button id="nextRow" class="btn">Siguiente ‚ü∂</button>
    <span id="rowInfo" class="small"></span>
  </div>

  <div class="grp">
    <button id="shuffle" class="btn" title="Generar nuevas letras/rotaciones">‚Üª Nuevas letras</button>
  </div>

  <div class="grp">
    <span class="small">Primera fila 20/400 ‚Üí √∫ltima 20/20 ‚Ä¢ Escala uniforme en logMAR ‚Ä¢ Patr√≥n: 1,2,3,4,5 y luego 6</span>
  </div>
</header>

<main>
  <section>
    <h3 class="small" style="margin:0 0 6px">Calibraci√≥n (obligatoria la primera vez)</h3>
    <div class="barWrap">
      <div id="calBar" class="bar" style="width:200px"></div>
      <input id="barRange" type="range" min="50" max="600" step="1" value="200">
      <div>
        <div class="small">Ajusta la barra para que mida <b>50 mm</b> con tu regla.</div>
        <div class="small">Ancho actual: <span id="barPx">200</span> px ‚Üí <span id="pxPerMM">4.00</span> px/mm</div>
      </div>
      <button id="lockCal" class="btn">‚úî Guardar</button>
      <span id="calStatus" class="small"></span>
    </div>
  </section>

  <section id="chart"></section>
</main>

<script>
/* ========= Utilidades ========= */
const DEG = Math.PI/180;
const SLOAN = ["C","D","H","K","N","O","R","S","V","Z"];
const rand = arr => arr[Math.floor(Math.random()*arr.length)];
const randE = () => [0,90,180,270][Math.floor(Math.random()*4)];

const store = {
  get pxPerMM(){ return parseFloat(localStorage.getItem('pxPerMM')||"")||null; },
  set pxPerMM(v){ localStorage.setItem('pxPerMM', String(v)); }
};

/* ========= DOM ========= */
const distanceM = document.getElementById('distanceM');
const alphabetSel = document.getElementById('alphabet');
const rowsPreset = document.getElementById('rowsPreset');
const viewMode = document.getElementById('viewMode');
const prevRow = document.getElementById('prevRow');
const nextRow = document.getElementById('nextRow');
const rowInfo = document.getElementById('rowInfo');
const chart = document.getElementById('chart');

const bar = document.getElementById('calBar');
const barRange = document.getElementById('barRange');
const barPx = document.getElementById('barPx');
const pxPerMMEl = document.getElementById('pxPerMM');
const lockCal = document.getElementById('lockCal');
const calStatus = document.getElementById('calStatus');

/* ========= Barra de calibraci√≥n ========= */
function updateBarUI(px){
  bar.style.width = px + "px";
  barPx.textContent = px;
  const ppm = (px/50);
  pxPerMMEl.textContent = ppm.toFixed(2);
}
barRange.addEventListener('input', e => updateBarUI(parseInt(e.target.value,10)));
updateBarUI(parseInt(barRange.value,10));

lockCal.addEventListener('click', () => {
  const ppm = parseFloat(pxPerMMEl.textContent);
  store.pxPerMM = ppm;
  calStatus.textContent = `Guardado (${ppm.toFixed(2)} px/mm)`;
  render(false); // no regenera letras
});

if(store.pxPerMM){
  pxPerMMEl.textContent = store.pxPerMM.toFixed(2);
  const px = Math.round(store.pxPerMM*50);
  barRange.value = px;
  updateBarUI(px);
  calStatus.textContent = `Usando calibraci√≥n guardada`;
}

/* ========= Patr√≥n de letras por fila ========= */
function rowsForPreset(n){
  const arr = [];
  for(let i=0;i<n;i++){
    if(i===0) arr.push(1);
    else if(i===1) arr.push(2);
    else if(i===2) arr.push(3);
    else if(i===3) arr.push(4);
    else if(i===4) arr.push(5);
    else arr.push(6);
  }
  return arr;
}

/* ========= Conversi√≥n tama√±os ========= */
// altura de optotipo (mm) para un logMAR dado y distancia D (m)
function letterHeightMM(distance_m, logMAR){
  const Dmm = distance_m*1000;
  const MAR = Math.pow(10, logMAR);     // minutos de arco
  const angleDeg = 5*MAR/60;            // altura subtende 5*MAR (min de arco)
  const angleRad = angleDeg*DEG;
  return 2 * Dmm * Math.tan(angleRad/2);
}
// Snellen 20/x a partir de logMAR
function snellen20ft(logMAR){
  const denom = 20 / Math.pow(10, -logMAR);
  return `20/${Math.round(denom)}`;
}

/* ========= LogMAR por fila (20/400 ‚Üí 20/20) ========= */
const START_DEN = 400; // 20/400
const END_DEN   = 20;  // 20/20
const START_LOGMAR = Math.log10(START_DEN/20); // ‚âà 1.3010
const END_LOGMAR   = 0.0;

// genera un array de logMAR desde 20/400 hasta 20/20, espaciado uniforme seg√∫n #filas
function logmarArray(rowsN){
  if(rowsN <= 1) return [START_LOGMAR];
  const step = (START_LOGMAR - END_LOGMAR) / (rowsN - 1);
  return Array.from({length: rowsN}, (_,i) => START_LOGMAR - i*step);
}

/* ========= Generaci√≥n fija de letras ========= */
let lettersCache = [];
let rotCache = [];
let cacheMode = 'sloan';
let cacheKey = '';
function generateLetters(counts, mode, logs){
  cacheMode = mode;
  cacheKey = counts.join(',') + '|' + logs.map(x=>x.toFixed(4)).join(',');
  lettersCache = counts.map(cnt => Array.from({length: cnt}, _ => mode==='sloan' ? rand(SLOAN) : 'E'));
  rotCache = counts.map(cnt => Array.from({length: cnt}, _ => randE()));
}

/* ========= Render ========= */
let currentRow = 0;
const clamp = (v,a,b) => Math.max(a, Math.min(b, v));

function render(regenerate){
  const ppm = store.pxPerMM;
  chart.innerHTML = '';
  if(!ppm){
    const p = document.createElement('p');
    p.textContent = 'üëâ Primero calibra la barra a 50 mm y pulsa "Guardar".';
    chart.appendChild(p);
    return;
  }
  const Dm = parseFloat(distanceM.value||'3') || 3.0;
  const rowsN = parseInt(rowsPreset.value,10);
  const counts = rowsForPreset(rowsN);
  const logs = logmarArray(rowsN);
  const mode = alphabetSel.value;

  // regenerar solo cuando cambia algo estructural o el usuario lo pide
  const newKey = counts.join(',') + '|' + logs.map(x=>x.toFixed(4)).join(',') + '|' + mode;
  if (regenerate || newKey !== cacheKey + '|' + cacheMode) {
    generateLetters(counts, mode, logs);
  }

  if(viewMode.value === 'one'){
    currentRow = clamp(currentRow, 0, counts.length-1);
    rowInfo.textContent = `Fila ${currentRow+1} / ${counts.length}`;
  } else {
    rowInfo.textContent = '';
  }

  counts.forEach((cnt, idx) => {
    if(viewMode.value === 'one' && idx !== currentRow) return;

    const logMAR = logs[idx];
    const Hmm = letterHeightMM(Dm, logMAR);
    const Hpx = Hmm * ppm;

    const rowWrap = document.createElement('div');
    rowWrap.className = 'rowWrap';

    const row = document.createElement('div');
    row.className = 'row';
    row.style.gap = Math.round(Hpx) + 'px'; // crowding ‚âà 1√ó altura

    for(let i=0;i<cnt;i++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      if(mode==='sloan'){
        cell.textContent = lettersCache[idx][i];
        cell.style.fontSize = `${Hpx}px`;
      } else {
        const e = document.createElement('span');
        e.className = 'tumble';
        e.textContent = 'E';
        e.style.fontSize = `${Hpx}px`;
        e.style.transform = `rotate(${rotCache[idx][i]}deg)`;
        cell.appendChild(e);
      }
      row.appendChild(cell);
    }

    const lbl = document.createElement('div');
    lbl.className = 'label';
    lbl.textContent = `${snellen20ft(logMAR)} ‚Ä¢ logMAR ${logMAR.toFixed(2)}`;

    rowWrap.appendChild(row);
    rowWrap.appendChild(lbl);
    chart.appendChild(rowWrap);
  });
}

/* ========= Eventos ========= */
// no regeneran: distancia y vista
distanceM.addEventListener('input', ()=>render(false));
distanceM.addEventListener('change', ()=>render(false));
viewMode.addEventListener('change', ()=>render(false));
// s√≠ regeneran: cambio de filas, alfabeto y "Nuevas letras"
rowsPreset.addEventListener('change', ()=>render(true));
alphabetSel.addEventListener('change', ()=>render(true));
document.getElementById('shuffle').addEventListener('click', ()=>render(true));
// navegaci√≥n de filas
document.getElementById('prevRow').addEventListener('click', ()=>{ currentRow = clamp(currentRow-1,0,999); render(false); });
document.getElementById('nextRow').addEventListener('click', ()=>{ currentRow = clamp(currentRow+1,0,999); render(false); });

// primer render genera las letras una vez
render(true);
</script>
</body>
</html>

Obtener Outlook para iOS
De: LUIS NICOLAS LEON SUAREZ <luis_nls@hotmail.com>
Enviado: Thursday, October 2, 2025 12:16:28 PM
Para: luis.leon@redoftalmomedic.pe <luis.leon@redoftalmomedic.pe>
Asunto: Re: OPTO
 
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Snellen en filas ‚Äì 20/x ‚Ä¢ logMAR 0.1</title>
<style>
  :root { --fg:#111; --bg:#fff; --mut:#777; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #e5e5e5;background:var(--bg)}
  header .grp{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  header label{font-size:13px;opacity:.9}
  header input[type="number"]{width:6.5rem;padding:6px}
  header select{padding:6px}
  .btn{padding:6px 10px;border:1px solid #999;background:#f7f7f7;border-radius:6px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .small{font-size:12px;color:var(--mut)}
  main{padding:12px 10px;max-width:1200px;margin:0 auto}
  /* Calibraci√≥n */
  .barWrap{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:6px}
  .bar{height:12px;background:#ccc;border:1px solid #999;box-shadow: inset 0 0 0 2px #eee}
  /* Carta */
  #chart{display:grid;gap:16px;align-content:start;margin-top:8px}
  .rowWrap{display:flex;flex-direction:column;align-items:center}
  .row{display:flex;gap:1ch;justify-content:center;align-items:flex-end;line-height:1}
  .cell{display:inline-block;font-weight:700;user-select:none;-webkit-user-select:none}
  .tumble{display:inline-block;transform-origin:50% 50%}
  .label{font-size:12px;text-align:center;margin-top:4px;color:var(--mut)}
</style>
</head>
<body>

<header>
  <div class="grp">
    <label>Distancia (m):
      <input id="distanceM" type="number" min="0.5" max="10" step="0.1" value="3.0">
    </label>
  </div>

  <div class="grp">
    <label>Signos:
      <select id="alphabet">
        <option value="sloan">Sloan (CDHKNORSVZ)</option>
        <option value="tumbleE">Tumbling-E</option>
      </select>
    </label>
  </div>

  <div class="grp">
    <label>Filas:
      <select id="rowsPreset">
        <option value="8">8</option>
        <option value="10" selected>10</option>
        <option value="12">12</option>
      </select>
    </label>
  </div>

  <div class="grp">
    <label>Vista:
      <select id="viewMode">
        <option value="all" selected>Todas las filas</option>
        <option value="one">Una fila</option>
      </select>
    </label>
    <button id="prevRow" class="btn">‚üµ Anterior</button>
    <button id="nextRow" class="btn">Siguiente ‚ü∂</button>
    <span id="rowInfo" class="small"></span>
  </div>

  <div class="grp">
    <button id="shuffle" class="btn">‚Üª Nuevas letras</button>
  </div>

  <div class="grp">
    <span class="small">Progresi√≥n: logMAR base 1.0, paso ‚àí0.1/fila ‚Ä¢ Etiqueta: 20/x</span>
  </div>
</header>

<main>
  <section>
    <h3 class="small" style="margin:0 0 6px 0;">Calibraci√≥n (obligatoria la primera vez)</h3>
    <div class="barWrap">
      <div id="calBar" class="bar" style="width:200px"></div>
      <input id="barRange" type="range" min="50" max="600" step="1" value="200">
      <div>
        <div class="small">Ajusta la barra para que mida <b>50 mm</b> con tu regla f√≠sica.</div>
        <div class="small">Ancho actual: <span id="barPx">200</span> px ‚Üí <span id="pxPerMM">4.00</span> px/mm</div>
      </div>
      <button id="lockCal" class="btn">‚úî Guardar</button>
      <span id="calStatus" class="small"></span>
    </div>
  </section>

  <section id="chart"></section>
</main>

<script>
/* ========= Utilidades ========= */
const DEG = Math.PI/180;
const SLOAN = ["C","D","H","K","N","O","R","S","V","Z"];
const rand = arr => arr[Math.floor(Math.random()*arr.length)];
const randE = () => [0,90,180,270][Math.floor(Math.random()*4)];

const store = {
  get pxPerMM(){ return parseFloat(localStorage.getItem('pxPerMM')||"")||null; },
  set pxPerMM(v){ localStorage.setItem('pxPerMM', String(v)); }
};

/* ========= DOM ========= */
const distanceM = document.getElementById('distanceM');
const alphabetSel = document.getElementById('alphabet');
const rowsPreset = document.getElementById('rowsPreset');
const viewMode = document.getElementById('viewMode');
const prevRow = document.getElementById('prevRow');
const nextRow = document.getElementById('nextRow');
const rowInfo = document.getElementById('rowInfo');
const chart = document.getElementById('chart');

const bar = document.getElementById('calBar');
const barRange = document.getElementById('barRange');
const barPx = document.getElementById('barPx');
const pxPerMMEl = document.getElementById('pxPerMM');
const lockCal = document.getElementById('lockCal');
const calStatus = document.getElementById('calStatus');

function updateBarUI(px){
  bar.style.width = px + "px";
  barPx.textContent = px;
  const ppm = (px/50);
  pxPerMMEl.textContent = ppm.toFixed(2);
}
barRange.addEventListener('input', e => updateBarUI(parseInt(e.target.value,10)));
updateBarUI(parseInt(barRange.value,10));

lockCal.addEventListener('click', () => {
  const ppm = parseFloat(pxPerMMEl.textContent);
  store.pxPerMM = ppm;
  calStatus.textContent = `Guardado (${ppm.toFixed(2)} px/mm)`;
  render();
});

if(store.pxPerMM){
  pxPerMMEl.textContent = store.pxPerMM.toFixed(2);
  const px = Math.round(store.pxPerMM*50);
  barRange.value = px;
  updateBarUI(px);
  calStatus.textContent = `Usando calibraci√≥n guardada`;
}

/* ========= L√≥gica de filas ========= */
/* Patr√≥n solicitado:
   1, 2, 3, 4, 5, y de ah√≠ en adelante todas con 6 letras hasta completar N filas */
function rowsForPreset(n){
  const arr = [];
  for(let i=0;i<n;i++){
    if(i===0) arr.push(1);
    else if(i===1) arr.push(2);
    else if(i===2) arr.push(3);
    else if(i===3) arr.push(4);
    else if(i===4) arr.push(5);
    else arr.push(6);
  }
  return arr;
}

/* Tama√±o f√≠sico de letra desde logMAR y distancia */
function letterHeightMM(distance_m, logMAR){
  const Dmm = distance_m*1000;
  const MAR = Math.pow(10, logMAR); // minutos de arco
  const angleDeg = 5*MAR/60;        // altura subtende 5*MAR (min de arco)
  const angleRad = angleDeg*DEG;
  return 2 * Dmm * Math.tan(angleRad/2);
}

/* Snellen a 20 pies (equivalente a 6 m) */
function snellen20ft(logMAR){
  const denom = 20 / Math.pow(10, -logMAR);
  return `20/${Math.round(denom)}`;
}

/* ========= Render ========= */
let currentRow = 0;
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

function render(){
  const ppm = store.pxPerMM;
  chart.innerHTML = '';
  if(!ppm){
    const p = document.createElement('p');
    p.textContent = 'üëâ Primero calibra la barra a 50 mm y pulsa "Guardar".';
    chart.appendChild(p);
    return;
  }
  const Dm = parseFloat(distanceM.value||'3') || 3.0;
  const rowsN = parseInt(rowsPreset.value,10);
  const counts = rowsForPreset(rowsN);

  if(viewMode.value === 'one'){
    currentRow = clamp(currentRow, 0, counts.length-1);
    rowInfo.textContent = `Fila ${currentRow+1} / ${counts.length}`;
  } else {
    rowInfo.textContent = '';
  }

  const baseLogMAR = 1.0; // fila 1 grande
  counts.forEach((cnt, idx) => {
    if(viewMode.value === 'one' && idx !== currentRow) return;

    const logMAR = baseLogMAR - 0.1*idx;
    const Hmm = letterHeightMM(Dm, logMAR);
    const Hpx = Hmm * ppm;

    const rowWrap = document.createElement('div');
    rowWrap.className = 'rowWrap';

    const row = document.createElement('div');
    row.className = 'row';
    row.style.gap = Math.round(Hpx) + 'px'; // crowding ‚âà 1√ó altura

    for(let i=0;i<cnt;i++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      if(alphabetSel.value==='sloan'){
        cell.textContent = SLOAN[Math.floor(Math.random()*SLOAN.length)];
        cell.style.fontSize = `${Hpx}px`;
      } else {
        const e = document.createElement('span');
        e.className = 'tumble';
        e.textContent = 'E';
        e.style.fontSize = `${Hpx}px`;
        e.style.transform = `rotate(${randE()}deg)`;
        cell.appendChild(e);
      }
      row.appendChild(cell);
    }

    const lbl = document.createElement('div');
    lbl.className = 'label';
    lbl.textContent = `${snellen20ft(logMAR)} ‚Ä¢ logMAR ${logMAR.toFixed(1)}`;

    rowWrap.appendChild(row);
    rowWrap.appendChild(lbl);
    chart.appendChild(rowWrap);
  });
}

/* ========= Eventos ========= */
['input','change'].forEach(evt=>{
  distanceM.addEventListener(evt, render);
  alphabetSel.addEventListener(evt, render);
  rowsPreset.addEventListener(evt, render);
  viewMode.addEventListener(evt, render);
});
document.getElementById('shuffle').addEventListener('click', render);
document.getElementById('prevRow').addEventListener('click', ()=>{ currentRow = clamp(currentRow-1,0,999); render(); });
document.getElementById('nextRow').addEventListener('click', ()=>{ currentRow = clamp(currentRow+1,0,999); render(); });

/* Primer render */
render();
</script>
</body>
</html>
